# OTP認証仕様

## 概要
本システムにおけるOTP（One-Time Password）認証の実装仕様を定義します。

## OTP認証フロー

### 1. OTP設定
1. ユーザーがOTP設定を有効化
2. システムがシークレットキーを生成
3. QRコードをユーザーに表示
4. ユーザーが認証アプリでQRコードをスキャン
5. バックアップコードを生成・表示
6. 初回認証で設定を確定

### 2. OTP認証プロセス
1. ユーザーがパスワード認証を完了
2. システムがOTP入力を要求
3. ユーザーが認証アプリのコードを入力
4. システムがコードを検証
5. 認証成功時にセッショントークンを発行

### 3. バックアップコード
- 16文字のランダムコードを8個生成
- 一度使用したコードは無効化
- 残り3個以下でユーザーに警告
- 全て使用した場合は再生成が必要

### 4. 信頼済みデバイス
- デバイス情報を記録（ブラウザ、OS等）
- 30日間の信頼期間を設定
- 信頼期間中はOTP認証をスキップ
- ユーザーはデバイス一覧を管理可能

## セキュリティ要件

### 1. OTPアルゴリズム
- TOTP (RFC 6238)
- SHA-256ハッシュ関数
- 30秒の時間窓
- 6桁の数字コード

### 2. シークレットキー
- 32バイトのランダム値
- Base32エンコード
- データベースで暗号化して保存

### 3. レート制限
- 3回の連続失敗で1分間ロック
- 10回の連続失敗で管理者に通知
- 24時間で最大100回の試行

### 4. 監査ログ
- OTP有効化/無効化
- 認証成功/失敗
- バックアップコード使用
- デバイス信頼設定

## エラーハンドリング

### 1. 認証エラー
- 無効なコード
- 期限切れのコード
- レート制限超過
- アカウントロック

### 2. 設定エラー
- QRコードスキャン失敗
- 初回認証失敗
- シークレットキー生成失敗

### 3. デバイスエラー
- 信頼期間切れ
- デバイス情報の不一致
- 不正なデバイスアクセス

## リカバリープロセス

### 1. デバイス紛失時
1. バックアップコードによる認証
2. 新規デバイスでのOTP再設定
3. 旧デバイスの信頼設定を無効化

### 2. バックアップコード紛失時
1. 管理者への連絡
2. 本人確認
3. OTP設定のリセット

### 3. アカウントロック時
1. バックアップコード使用
2. 管理者による解除
3. 本人確認後の再設定 